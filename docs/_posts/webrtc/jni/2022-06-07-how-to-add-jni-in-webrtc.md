---
layout: default
title:  "How to add jni in WebRTC"
date:   2022-06-07 15:31:33 +0800
categories: webrtc
---

# Abstract
About how to add jni in WebRTC.
We use an example of creating an AV1 encoder for android to illustrate this.
# Create java file which need adding jni
We can create a java file which need adding jni at proper location.
Commonly,package name for java files in WebRTC is `org.webrtc`,location is:`src/sdk/android/`

## Create java file
Create an encoder file named `LibaomAv1Encoder.java` at `src/sdk/android/api/org/webrtc/`
```java
package org.webrtc;

public class LibaomAv1Encoder extends WrappedNativeVideoEncoder {
  @Override
  public long createNativeVideoEncoder() {
    return nativeCreateEncoder();
  }

  static native long nativeCreateEncoder();

  @Override
  public boolean isHardwareEncoder() {
    return false;
  }

  static native boolean nativeIsSupported();
}
```

In this example,`LibaomAv1Encoder` need calling native functions as below
- `createEncoder`
- `isSupported`

## Add java file in BUILD.gn
Add java file in `src/sdk/android/BUILD.gn`,so that it can be generated by `gn` and then compiled by `ninja` 
```gn
  rtc_android_library("libaom_av1_java") {
    visibility = [ "*" ]
    sources = [
      "api/org/webrtc/LibaomAv1Encoder.java",
    ]
    deps = [
      ":base_java",
      ":video_api_java",
      ":video_java",
      "//rtc_base:base_java",
    ]
  }
```

# Add jni for java file
## Define a `generate_jni` target
Firstly,we need defining a target of `generate_jni` in `src/sdk/android/BUILD.gn`
- Define a `generate_jni` target `generated_libaom_av1_jni`
- Add java file needs adding jni to `sources`

```gn
  generate_jni("generated_libaom_av1_jni") {
    sources = [
      "api/org/webrtc/LibaomAv1Encoder.java",
    ]

    namespace = "webrtc::jni"
    jni_generator_include = "//sdk/android/src/jni/jni_generator_helper.h"
  }

```

## Implements native methods of java
- Add a target to contain the file which implements the jni methods.Here is `libaom_av1_jni`.
```gn
  rtc_library("libaom_av1_jni") {
    visibility = [ "*" ]
    allow_poison = [ "software_video_codecs" ]
    sources = [ "src/jni/av1_codec.cc" ]
    deps = [
      ":base_jni",
      ":generated_libaom_av1_jni",
      ":video_jni",
      "../../modules/video_coding/codecs/av1:libaom_av1_encoder",
    ]
  }
```
- Implements jni methods at file`src/jni/av1_codec.cc`.

```c++
#include <jni.h>

#include "modules/video_coding/codecs/av1/libaom_av1_encoder.h"
#include "sdk/android/generated_libaom_av1_jni/LibaomAv1Encoder_jni.h"
#include "sdk/android/src/jni/jni_helpers.h"

namespace webrtc {
namespace jni {

static jlong JNI_LibaomAv1Encoder_CreateEncoder(JNIEnv* jni) {
  return jlongFromPointer(CreateLibaomAv1Encoder().release());
}

static jboolean JNI_LibaomAv1Encoder_IsSupported(JNIEnv* jni) {
  return kIsLibaomAv1EncoderSupported;
}

}  // namespace jni
}  // namespace webrtc
```

**NOTE:** We include the automatically generated jni header here.Format of the file path is `target_name_of_generate_jni/java_class_name_jni.h`
```c++
#include "sdk/android/generated_libaom_av1_jni/LibaomAv1Encoder_jni.h"
```

**NOTE:** method definitions MUST be the same within the automacitically generated `LibaomAV1Encoder_jni.h`,otherwise,compling failed as below.
```shell
In file included from ../../sdk/android/src/jni/scalability_helpers.cc:14:
gen/sdk/android/generated_scalability_helpers_jni/ScalabilityHelpers_jni.h:54:13: error: function 'xwebrtc::jni::JNI_ScalabilityHelpers_GetNumberOfSpatialLayers' has internal linkage but is not defined [-Werror,-Wundefined-internal]
static jint JNI_ScalabilityHelpers_GetNumberOfSpatialLayers(JNIEnv* env, const
            ^
gen/sdk/android/generated_scalability_helpers_jni/ScalabilityHelpers_jni.h:61:10: note: used here
  return JNI_ScalabilityHelpers_GetNumberOfSpatialLayers(env,
         ^
1 error generated.
```

## What's the automatically generated jni looks like
Location of genrerated jni is at `out/arm/gen/sdk/android/generated_libaom_av1_jni/LibaomAv1Encoder_jni.h`
```c++
// Copyright 2014 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.


// This file is autogenerated by
//     base/android/jni_generator/jni_generator.py
// For
//     org/webrtc/LibaomAv1Encoder

#ifndef org_webrtc_LibaomAv1Encoder_JNI
#define org_webrtc_LibaomAv1Encoder_JNI

#include <jni.h>

#include "../../../../../../sdk/android/src/jni/jni_generator_helper.h"


// Step 1: Forward declarations.

JNI_REGISTRATION_EXPORT extern const char kClassPath_org_webrtc_LibaomAv1Encoder[];
const char kClassPath_org_webrtc_LibaomAv1Encoder[] = "org/webrtc/LibaomAv1Encoder";
// Leaking this jclass as we cannot use LazyInstance from some threads.
JNI_REGISTRATION_EXPORT std::atomic<jclass> g_org_webrtc_LibaomAv1Encoder_clazz(nullptr);
#ifndef org_webrtc_LibaomAv1Encoder_clazz_defined
#define org_webrtc_LibaomAv1Encoder_clazz_defined
inline jclass org_webrtc_LibaomAv1Encoder_clazz(JNIEnv* env) {
  return base::android::LazyGetClass(env, kClassPath_org_webrtc_LibaomAv1Encoder,
      &g_org_webrtc_LibaomAv1Encoder_clazz);
}
#endif


// Step 2: Constants (optional).


// Step 3: Method stubs.
namespace  webrtc {
namespace jni {

static jlong JNI_LibaomAv1Encoder_CreateEncoder(JNIEnv* env);

JNI_GENERATOR_EXPORT jlong Java_org_webrtc_LibaomAv1Encoder_nativeCreateEncoder(
    JNIEnv* env,
    jclass jcaller) {
  return JNI_LibaomAv1Encoder_CreateEncoder(env);
}

static jboolean JNI_LibaomAv1Encoder_IsSupported(JNIEnv* env);

JNI_GENERATOR_EXPORT jboolean Java_org_webrtc_LibaomAv1Encoder_nativeIsSupported(
    JNIEnv* env,
    jclass jcaller) {
  return JNI_LibaomAv1Encoder_IsSupported(env);
}


}  // namespace jni
}  // namespace  webrtc

#endif  // org_webrtc_LibaomAv1Encoder_JNI

```

## Issues encountered
### java.lang.ClassNotFoundException when loading Java class by jni
Errors as below:
```shell
08-19 10:56:40.762 27527 27631 W System.err: java.lang.ClassNotFoundException: Didn't find class "org.webrtc.RTCVideoCodecPerformanceProbeResult$RTCVideoCodecPerformanceProbeResult" on path: DexPathList[[zip file "/data/app/com.xx.mobile.coredemo-hITeGmuPpKxq-VLBRsjI-A==/base.apk"],nativeLibraryDirectories=[/data/app/com.xx.mobile.artvccoredemo-hITeGmuPpKxq-VLBRsjI-A==/lib/arm, /data/app/com.xx.mobile.artvccoredemo-hITeGmuPpKxq-VLBRsjI-A==/base.apk!/lib/armeabi, /system/lib, /system/product/lib]]
08-19 10:56:40.762 27527 27631 W System.err: 	at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:196)
08-19 10:56:40.762 27527 27631 W System.err: 	at java.lang.ClassLoader.loadClass(ClassLoader.java:379)
08-19 10:56:40.762 27527 27631 W System.err: 	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)
08-19 10:56:40.762 27527 27631 E rtc     : 
08-19 10:56:40.762 27527 27631 E rtc     : 
08-19 10:56:40.762 27527 27631 E rtc     : #
08-19 10:56:40.762 27527 27631 E rtc     : # Fatal error in: ../../sdk/android/native_api/jni/class_loader.cc, line 53
08-19 10:56:40.762 27527 27631 E rtc     : # last system error: 0
08-19 10:56:40.762 27527 27631 E rtc     : # Check failed: !env->ExceptionCheck()
08-19 10:56:40.762 27527 27631 E rtc     : # 
```

`org.webrtc.RTCVideoCodecPerformanceProbeResult$RTCVideoCodecPerformanceProbeResult` means that the class path is within class `RTCVideoCodecPerformanceProbeResult`,try to finding an internal class named `RTCVideoCodecPerformanceProbeResult` within the class `RTCVideoCodecPerformanceProbeResult`.However,we don't have any internal class `RTCVideoCodecPerformanceProbeResult` within `RTCVideoCodecPerformanceProbeResult`.

So the problem caused by a wrong setting on `@CalledByNative`
```Java
public class RTCVideoCodecPerformanceProbeResult {

    @CalledByNative("RTCVideoCodecPerformanceProbeResult")
    RTCVideoCodecPerformanceProbeResult(){
    }
}
```

The valid class path is `org.webrtc.RTCVideoCodecPerformanceProbeResult` ,we need setting `@CalledByNative` without specifying any sub path for the original class.

```Java
public class RTCVideoCodecPerformanceProbeResult {

    @CalledByNative
    RTCVideoCodecPerformanceProbeResult(){
    }
}
```

However,if we add an internal class within `RTCVideoCodecPerformanceProbeResult` and then need adding sub path for which.

```Java
public class RTCVideoCodecPerformanceProbeResult {
public static class XXX{
    @CalledByNative("XXX")
    XXX(){
    }

}

    @CalledByNative
    RTCVideoCodecPerformanceProbeResult(){
    }

}
```
The class path for `XXX` is  then `org.webrtc.RTCVideoCodecPerformanceProbeResult$XXX`
